name: ğŸ”„ å¢å¼ºæœç´¢å¤„ç†

on:
  repository_dispatch:
    types: 
      - continue_search    # ç»§ç»­æœç´¢
      - finalize_search    # ç”Ÿæˆæœ€ç»ˆç»“æœ

jobs:
  enhanced-search:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: ğŸ”§ å‡†å¤‡ç¯å¢ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ”„ å¤„ç†ç»§ç»­æœç´¢
      if: github.event.action == 'continue_search'
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        ENVIRONMENT: "production"
        SEARCH_QUERY: ${{ github.event.client_payload.query }}
        CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
        WORKSPACE_ID: ${{ github.event.client_payload.workspace_id }}
        SEARCH_ID: ${{ github.event.client_payload.search_id }}
        MAX_ROUNDS: ${{ github.event.client_payload.max_rounds }}
        CONTINUE_FROM_STATE: ${{ github.event.client_payload.continue_from_state }}
        IS_CONTINUATION: 'true'
        INCLUDE_SCRAPING: ${{ github.event.client_payload.include_scraping }}
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode }}
        SILENT_MODE: ${{ github.event.client_payload.silent_mode }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_ACTIONS: "true"
        RUNNER_OS: ${{ runner.os }}
      run: |
        echo "ğŸ”„ ç»§ç»­æœç´¢æ¨¡å¼"
        echo "ğŸ“‹ åŸå§‹æŸ¥è¯¢: $SEARCH_QUERY"
        echo "ğŸ“ å›è°ƒç«¯ç‚¹: $CALLBACK_URL"
        echo "ğŸ†” æœç´¢ID: $SEARCH_ID"
        echo "ğŸ  å·¥ä½œç©ºé—´: $WORKSPACE_ID"
        echo "ğŸ”„ é¢å¤–è½®æ¬¡: $MAX_ROUNDS"
        echo "ğŸ“Š ä»çŠ¶æ€ç»§ç»­: $(echo "$CONTINUE_FROM_STATE" | head -c 100)..."
        echo ""
        echo "ğŸš€ å¼€å§‹ç»§ç»­æœç´¢..."
        echo ""
        
        python -m api.enhanced_runner --mode continue
        
    - name: ğŸ“ å¤„ç†ç”Ÿæˆæœ€ç»ˆç»“æœ
      if: github.event.action == 'finalize_search'
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        ENVIRONMENT: "production"
        SEARCH_QUERY: ${{ github.event.client_payload.query }}
        CALLBACK_URL: ${{ github.event.client_payload.callback_url }}
        WORKSPACE_ID: ${{ github.event.client_payload.workspace_id }}
        SEARCH_ID: ${{ github.event.client_payload.search_id }}
        ITERATIONS_DATA: ${{ github.event.client_payload.iterations }}
        FINAL_STATE: ${{ github.event.client_payload.final_state }}
        ACTION_TYPE: 'finalize'
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode }}
        SILENT_MODE: ${{ github.event.client_payload.silent_mode }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_ACTIONS: "true"
        RUNNER_OS: ${{ runner.os }}
      run: |
        echo "ğŸ“ ç”Ÿæˆæœ€ç»ˆç»“æœæ¨¡å¼"
        echo "ğŸ“‹ åŸå§‹æŸ¥è¯¢: $SEARCH_QUERY"
        echo "ğŸ“ å›è°ƒç«¯ç‚¹: $CALLBACK_URL"
        echo "ğŸ†” æœç´¢ID: $SEARCH_ID"
        echo "ğŸ  å·¥ä½œç©ºé—´: $WORKSPACE_ID"
        echo "ğŸ“Š è¿­ä»£æ•°æ®é•¿åº¦: $(echo "$ITERATIONS_DATA" | wc -c)å­—ç¬¦"
        echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€é•¿åº¦: $(echo "$FINAL_STATE" | wc -c)å­—ç¬¦"
        echo ""
        echo "ğŸš€ å¼€å§‹ç”Ÿæˆæœ€ç»ˆç»“æœ..."
        echo ""
        
        python -m api.enhanced_runner --mode finalize
        
    - name: ğŸ“Š å¤„ç†ç»“æœæŠ¥å‘Š
      if: always()
      run: |
        echo "âœ… å¢å¼ºæœç´¢å¤„ç†å®Œæˆ"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
        echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
        echo "ğŸ Python ç‰ˆæœ¬: $(python --version)"
        echo "ğŸ“‹ å¤„ç†ç±»å‹: ${{ github.event.action }}"
        
        if [ "${{ github.event.action }}" = "continue_search" ]; then
          echo ""
          echo "ğŸ”„ ç»§ç»­æœç´¢å¤„ç†æ‘˜è¦ï¼š"
          echo "- æœç´¢ID: ${{ github.event.client_payload.search_id }}"
          echo "- é¢å¤–è½®æ¬¡: ${{ github.event.client_payload.max_rounds }}"
          echo "- æ˜¯å¦åŒ…å«ç½‘é¡µæŠ“å–: ${{ github.event.client_payload.include_scraping }}"
        elif [ "${{ github.event.action }}" = "finalize_search" ]; then
          echo ""
          echo "ğŸ“ æœ€ç»ˆç»“æœç”Ÿæˆæ‘˜è¦ï¼š"
          echo "- æœç´¢ID: ${{ github.event.client_payload.search_id }}"
          echo "- æŸ¥è¯¢å†…å®¹: ${{ github.event.client_payload.query }}"
          echo "- åŸºäºç°æœ‰è¿­ä»£æ•°æ®ç”Ÿæˆç»“æœ"
        fi 