name: ğŸ” DeepSeek æœç´¢ä»£ç†

on:
  repository_dispatch:
    types: [search_trigger]
  workflow_dispatch:
    inputs:
      query:
        description: 'æœç´¢æŸ¥è¯¢'
        required: true
        type: string
      callback_url:
        description: 'å›è°ƒ URL'
        required: false
        type: string
      workspace_id:
        description: 'å·¥ä½œç©ºé—´ ID'
        required: false
        type: string
      max_rounds:
        description: 'æœ€å¤§è¿­ä»£è½®æ•°'
        required: false
        type: string
        default: '5'
      debug_mode:
        description: 'è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  search:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ” æ‰§è¡Œæœç´¢
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        ENVIRONMENT: "production"
        # ä» repository_dispatch è·å–å‚æ•°
        SEARCH_QUERY: ${{ github.event.client_payload.query || inputs.query }}
        CALLBACK_URL: ${{ github.event.client_payload.callback_url || inputs.callback_url }}
        WORKSPACE_ID: ${{ github.event.client_payload.search_id || github.event.client_payload.workspace_id || inputs.workspace_id }}
        MAX_ROUNDS: ${{ github.event.client_payload.max_rounds || inputs.max_rounds }}
        INCLUDE_SCRAPING: ${{ github.event.client_payload.include_scraping || 'true' }}
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode || inputs.debug_mode || 'false' }}
        # GitHub ä¿¡æ¯
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_ACTIONS: "true"
        RUNNER_OS: ${{ runner.os }}
      run: |
        echo "ğŸš€ å¯åŠ¨ DeepSeek æœç´¢ä»£ç†"
        
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ› è°ƒè¯•æ¨¡å¼å·²å¯ç”¨ - æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
          echo "ğŸ“‹ æœç´¢æŸ¥è¯¢: $SEARCH_QUERY"
          echo "ğŸ“ å›è°ƒ URL: $CALLBACK_URL"
          echo "ğŸ  å·¥ä½œç©ºé—´: $WORKSPACE_ID"
          echo "ğŸ”„ æœ€å¤§è½®æ•°: $MAX_ROUNDS"
          echo "ğŸ”§ åŒ…å«æŠ“å–: $INCLUDE_SCRAPING"
          echo "ğŸŒ ç¯å¢ƒ: $ENVIRONMENT"
          echo "ğŸ” è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
        else
          echo "ğŸ” æ­£åœ¨å¤„ç†æœç´¢è¯·æ±‚..."
          echo "âš¡ æœç´¢è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™..."
        fi
        
        # ä½¿ç”¨æ–°çš„è¿­ä»£æœç´¢æ¶æ„è¿è¡Œæœç´¢ä»£ç†
        python -m api.github_runner
        
    - name: ğŸ“‹ è¾“å‡ºæ‰§è¡Œä¿¡æ¯
      if: always()
      env:
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode || inputs.debug_mode || 'false' }}
      run: |
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "âœ… æœç´¢ä»£ç†æ‰§è¡Œå®Œæˆ"
          echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
          echo "ğŸ Python ç‰ˆæœ¬: $(python --version)"
        else
          echo "âœ… æœç´¢ä»»åŠ¡å·²å®Œæˆ"
        fi
        
    - name: ğŸ§¹ æ¸…ç†å†å²å·¥ä½œæµ
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode || inputs.debug_mode || 'false' }}
      run: |
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ§¹ å¼€å§‹æ¸…ç†å†å²å·¥ä½œæµ..."
        fi
        
        # è·å–ä»“åº“ä¿¡æ¯
        REPO_OWNER=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
        REPO_NAME=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f2)
        
        # è·å–å½“å‰å·¥ä½œæµçš„ID
        CURRENT_RUN_ID="${{ github.run_id }}"
        
        # åˆ é™¤é™¤å½“å‰è¿è¡Œå¤–çš„æ‰€æœ‰å®Œæˆçš„å·¥ä½œæµè¿è¡Œ
        # è·å–æ‰€æœ‰å·²å®Œæˆçš„å·¥ä½œæµè¿è¡Œï¼ˆé™¤äº†å½“å‰çš„ï¼‰
        gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs \
          --paginate \
          --jq '.workflow_runs[] | select(.id != '$CURRENT_RUN_ID' and (.status == "completed" or .status == "cancelled" or .status == "failure")) | .id' \
          | head -20 \
          | while read run_id; do
            if [ "$DEBUG_MODE" = "true" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤å·¥ä½œæµè¿è¡Œ: $run_id"
            fi
            gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs/$run_id -X DELETE || true
            sleep 1
          done
        
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "âœ… å·¥ä½œæµæ¸…ç†å®Œæˆ"
        fi