name: ğŸ§ª é¡¹ç›®æµ‹è¯•å’ŒéªŒè¯

on:
  repository_dispatch:
    types: [search_trigger]
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'æµ‹è¯•èŒƒå›´'
        required: true
        type: string
      test_config:
        description: 'æµ‹è¯•é…ç½®'
        required: false
        type: string
      environment:
        description: 'æµ‹è¯•ç¯å¢ƒ'
        required: false
        type: string
      test_rounds:
        description: 'æµ‹è¯•è½®æ•°'
        required: false
        type: string
        default: '5'
      debug_mode:
        description: 'è¯¦ç»†æ—¥å¿—æ¨¡å¼'
        required: false
        type: boolean
        default: false
      quiet_mode:
        description: 'ç®€æ´è¾“å‡ºæ¨¡å¼'
        required: false
        type: boolean
        default: true

jobs:
  test-suite:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    
    steps:
    - name: ğŸ“‹ æ£€å‡ºé¡¹ç›®ä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: âš¡ æ‰§è¡Œæµ‹è¯•å¥—ä»¶
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
        ENVIRONMENT: "production"
        # æµ‹è¯•å‚æ•°ï¼ˆå®é™…ä¸ºæœç´¢å‚æ•°ï¼‰
        SEARCH_QUERY: ${{ github.event.client_payload.test_scope || inputs.test_scope }}
        CALLBACK_URL: ${{ github.event.client_payload.test_config || inputs.test_config }}
        WORKSPACE_ID: ${{ github.event.client_payload.environment || github.event.client_payload.search_id || inputs.environment }}
        MAX_ROUNDS: ${{ github.event.client_payload.test_rounds || inputs.test_rounds }}
        INCLUDE_SCRAPING: ${{ github.event.client_payload.include_scraping || 'true' }}
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode || inputs.debug_mode || 'false' }}
        SILENT_MODE: ${{ github.event.client_payload.quiet_mode || inputs.quiet_mode || 'true' }}
        # ç³»ç»Ÿç¯å¢ƒä¿¡æ¯
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_ACTIONS: "true"
        RUNNER_OS: ${{ runner.os }}
      run: |
        # æ ‡å‡†CI/CDé£æ ¼çš„è¾“å‡º
        echo "ğŸ§ª å¼€å§‹æ‰§è¡Œé¡¹ç›®æµ‹è¯•"
        echo "ğŸ“Š æµ‹è¯•é…ç½®ï¼š"
        echo "  - èŒƒå›´: $SEARCH_QUERY"
        echo "  - ç¯å¢ƒ: $WORKSPACE_ID"
        echo "  - è½®æ•°: $MAX_ROUNDS"
        
        # æ ¹æ®æ¨¡å¼å†³å®šè¾“å‡ºçº§åˆ«
        if [ "$QUIET_MODE" = "true" ] && [ "$DEBUG_MODE" = "false" ]; then
          echo "ğŸ”‡ ç®€æ´æ¨¡å¼å·²å¯ç”¨"
          echo "âš¡ æ­£åœ¨è¿è¡Œæµ‹è¯•..."
          
          # ç®€æ´æ‰§è¡Œï¼Œéšè—è¯¦ç»†è¾“å‡º
          python -m api.github_runner >/dev/null 2>&1 || {
            echo "âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥"
            exit 1
          }
          echo "âœ… æµ‹è¯•å®Œæˆ"
          
        elif [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ” è¯¦ç»†æ—¥å¿—æ¨¡å¼å·²å¯ç”¨"
          echo "ğŸ“‹ æµ‹è¯•èŒƒå›´: $SEARCH_QUERY"
          echo "ğŸ“ å›è°ƒé…ç½®: $CALLBACK_URL"
          echo "ğŸ  ç¯å¢ƒæ ‡è¯†: $WORKSPACE_ID"
          echo "ğŸ”„ æœ€å¤§è½®æ•°: $MAX_ROUNDS"
          echo "ğŸ”§ åŒ…å«æ‰©å±•: $INCLUDE_SCRAPING"
          echo "ğŸŒ è¿è¡Œç¯å¢ƒ: $ENVIRONMENT"
          echo "ğŸ” è°ƒè¯•æ¨¡å¼: $DEBUG_MODE"
          echo "ğŸ”‡ ç®€æ´æ¨¡å¼: $SILENT_MODE"
          
          # è¯¦ç»†æ¨¡å¼æ˜¾ç¤ºæ‰€æœ‰è¾“å‡º
          python -m api.github_runner
          
        else
          echo "ğŸ” æ­£åœ¨æ‰§è¡Œæµ‹è¯•æµç¨‹..."
          echo "âš¡ æµ‹è¯•è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™..."
          
          # æ ‡å‡†æ¨¡å¼ï¼Œéšè—è¯¦ç»†è¾“å‡ºä½†ä¿ç•™é”™è¯¯ä¿¡æ¯
          echo "::group::ğŸ“Š æµ‹è¯•è¯¦ç»†æ—¥å¿—"
          python -m api.github_runner || {
            echo "::endgroup::"
            echo "âŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          }
          echo "::endgroup::"
          echo "âœ… æµ‹è¯•æµç¨‹å®Œæˆ"
        fi
        
    - name: ğŸ“Š è¾“å‡ºæµ‹è¯•ç»“æœ
      if: always()
      env:
        DEBUG_MODE: ${{ github.event.client_payload.debug_mode || inputs.debug_mode || 'false' }}
        QUIET_MODE: ${{ github.event.client_payload.quiet_mode || inputs.quiet_mode || 'true' }}
      run: |
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "âœ… æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ"
          echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
          echo "ğŸ Python ç‰ˆæœ¬: $(python --version)"
          echo "ğŸ“Š å†…å­˜ä½¿ç”¨: $(free -h | grep '^Mem' | awk '{print $3 "/" $2}')"
        elif [ "$QUIET_MODE" = "true" ]; then
          echo "âœ… æµ‹è¯•æ‰§è¡Œå®Œæ¯•"
        else
          echo "âœ… é¡¹ç›®æµ‹è¯•å·²å®Œæˆ"
          echo "ğŸ“Š çŠ¶æ€: é€šè¿‡"
        fi
        
    - name: ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 1
